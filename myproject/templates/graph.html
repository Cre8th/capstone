<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <link rel="stylesheet" href="/static/ex.css" type="text/css">
</head>
<body>
    <div id="top" style="border: 2px solid;"></div>

    <button type="button" id="button">
        <img src="./start.png" width="45px" height="50px"/>
    </button>

    <select id="option">
        <option value="none">인터페이스 선택</option>
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option>4</option>
    </select>

    <input type="button" value="실행" id="start"/>

    <div id="chart-container">
        <canvas id="myLineChart"></canvas>
        <canvas id="myBarChart"></canvas>
    </div>

    <div id="line" style="border: 2px solid;"></div>
    <div id="bar" style="border: 2px solid;"></div>

    <div id="list1" style="border: 2px solid;"></div>
    <hr id="line1" style="border: solid 1px;"/>
    <b id="list1_text">정규표현식 매칭 패킷</b>

    <div id="list2" style="border: 2px solid;"></div>
    <hr id="line2" style="border: solid 1px;"/>
    <b id="list2_text">블랙리스트 IP</b>

    

    <script>
        async function getChart() {
            const protocol_response = await fetch('/protocol')
            const aggregate_response = await fetch('/aggregate')
            
            const protocol_data = await protocol_response.json()
            const aggregate_data = await aggregate_response.json()

            console.log("======== fetched chart data ========")
            console.log(protocol_data)
            console.log(aggregate_data)

            const protocols = []
            const ips = []

            aggregate_data.forEach(agg => {
                const { key, value } = agg;

                console.log(key)
                if (key.includes('protocol')) {
                    protocols.push({ name: key.split("-")[1], count: value } );
                }
                if (key.includes('ip')) {
                    ips.push({ name: key.split("-")[1], count: value } );
                }
            });

            console.log("======== transformed chart data ========")
            console.log(protocols)
            console.log(ips)

            return { protocols, ips }
        }

        function initChart(labels){
            const lineChartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Protocol Count',
                        data: [],
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    plugins: {
                        datalabels: {
                            color: 'red',
                            align: 'end',
                            anchor: 'end',
                            font: { weight: 'bold' }
                        }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            };

            const barChartConfig = {
                type: 'bar',
                data: {
                    labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                    datasets: [{
                        label: 'Sample Data',
                        data: [],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        datalabels: {
                            color: 'red',
                            align: 'end',
                            anchor: 'end',
                            font: { weight: 'bold' }
                        }
                    }
                }
            };

            return [new Chart(document.getElementById('myLineChart').getContext('2d'), lineChartConfig), new Chart(document.getElementById('myBarChart').getContext('2d'), barChartConfig)]
        }


        function updateChart(charts, counts){
            lineChart.data.datasets[0].data = counts;
            lineChart.update();
            barChart.data.datasets[0].data = counts;
            barChart.update();
        }

        Chart.register(ChartDataLabels);

        getChart().then((data) => {
            const charts = initChart(labels);

            updateChart(data);

            setInterval(() => {
                getChart().then(updatedData => {
                    updateChart(updatedData);
                });
            }, 3000);
        }).catch(e => console.error(`Failed to get chart data. [${e}]`));
    </script>
</body>
</html>